#!/usr/bin/env zsh

# Dotfiles installer with auto-discovery, logging, and error handling.
# Usage: DOTFILES=~/.dotfiles ./install [--verbose] [--dry-run]

set -u
set -o pipefail

DOTFILES="${DOTFILES:-$HOME/.dotfiles}"
LOG_FILE="$DOTFILES/.stow.log"
DRY_RUN=false
VERBOSE=false

print_usage() {
  cat <<'EOF'
Usage: ./install [--dry-run] [--verbose] [--help]
Environment:
  DOTFILES      Dotfiles directory (default: ~/.dotfiles)
  STOW_FOLDERS  Comma-separated folder list (default: auto-discover)
EOF
}

log_header() {
  {
    echo "=== Stow run: $(date '+%Y-%m-%d %H:%M:%S') ==="
    echo "Dotfiles location: $DOTFILES"
    echo "Dry run: $DRY_RUN"
    echo ""
  } >> "$LOG_FILE"
}

# Parse arguments.
while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --verbose)
      VERBOSE=true
      shift
      ;;
    --help|-h)
      print_usage
      exit 0
      ;;
    *)
      echo "âŒ Unknown argument: $1" >&2
      print_usage >&2
      exit 2
      ;;
  esac
done

if [[ ! -d "$DOTFILES" ]]; then
  echo "âŒ Dotfiles directory not found: $DOTFILES" >&2
  exit 1
fi

if ! command -v stow >/dev/null 2>&1; then
  echo "âŒ Required command not found: stow" >&2
  exit 1
fi

touch "$LOG_FILE" 2>/dev/null || {
  echo "âŒ Cannot write log file: $LOG_FILE" >&2
  exit 1
}

log_header

echo "ðŸ“¦ Starting dotfiles installation..."
echo "   Location: $DOTFILES"

cd "$DOTFILES" || {
  echo "âŒ Failed to enter directory: $DOTFILES" >&2
  exit 1
}

echo "ðŸ§¹ Checking for .DS_Store files..."
ds_store_count=$(find . -name ".DS_Store" -type f | wc -l | tr -d ' ')
if [[ "$DRY_RUN" == true ]]; then
  echo "   Dry run: would remove $ds_store_count file(s)"
else
  if [[ "$ds_store_count" -gt 0 ]]; then
    find . -name ".DS_Store" -type f -delete
  fi
  echo "   Removed $ds_store_count file(s)"
fi

# Resolve folders: use STOW_FOLDERS if set, otherwise auto-discover package directories.
typeset -a folders
if [[ -n "${STOW_FOLDERS:-}" ]]; then
  folders=(${(@s:,:)STOW_FOLDERS})
else
  folders=(${(f)"$(find . -mindepth 1 -maxdepth 1 -type d \
    -not -name '.*' \
    -not -name '__pycache__' \
    -exec basename {} \; | sort)"})
fi

if [[ ${#folders[@]} -eq 0 ]]; then
  echo "âŒ No dotfile folders found in $DOTFILES"
  exit 1
fi

echo "ðŸ“‚ Folders: ${folders[*]}"
echo ""

typeset -a stow_cmd
stow_cmd=(stow -R)
if [[ "$DRY_RUN" == true ]]; then
  stow_cmd+=(-n)
fi
if [[ "$VERBOSE" == true ]]; then
  stow_cmd+=(-v)
fi

# Track outcomes.
typeset -a failed_folders skipped_folders
success_count=0

for folder in "${folders[@]}"; do
  if [[ -z "$folder" ]]; then
    continue
  fi

  if [[ ! -d "$folder" ]]; then
    echo "âš ï¸  Skipping $folder (directory not found)"
    skipped_folders+=("$folder")
    continue
  fi

  echo -n "ðŸ”— Stowing $folder... "

  tmp_log=$(mktemp)
  if "${stow_cmd[@]}" "$folder" >"$tmp_log" 2>&1; then
    cat "$tmp_log" >> "$LOG_FILE"
    rm -f "$tmp_log"
    echo "âœ“"
    ((success_count++))
  else
    cat "$tmp_log" >> "$LOG_FILE"
    rm -f "$tmp_log"
    echo "âœ— FAILED"
    failed_folders+=("$folder")
    {
      echo ""
      echo "ERROR stowing $folder at $(date '+%Y-%m-%d %H:%M:%S')"
      echo ""
    } >> "$LOG_FILE"
  fi
done

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [[ ${#skipped_folders[@]} -gt 0 ]]; then
  echo "âš ï¸  Skipped folders:"
  printf "   â€¢ %s\n" "${skipped_folders[@]}"
fi

# Summary.
if [[ ${#failed_folders[@]} -eq 0 ]]; then
  echo "âœ… All $success_count folders stowed successfully"
  {
    echo "âœ… Completed successfully at $(date '+%Y-%m-%d %H:%M:%S')"
    echo ""
  } >> "$LOG_FILE"
  exit 0
fi

echo "âŒ Stowing completed with errors:"
printf "   â€¢ %s\n" "${failed_folders[@]}"
echo ""
echo "   Check log: $LOG_FILE"
{
  echo "âŒ Failed with ${#failed_folders[@]} folder(s) at $(date '+%Y-%m-%d %H:%M:%S')"
  echo "Failed folders: ${failed_folders[*]}"
  echo ""
} >> "$LOG_FILE"
exit 1
