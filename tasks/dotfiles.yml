- name: Install stow on Linux
  apt:
    name: stow
    state: present
  become: true
  when: ansible_system == "Linux"
  tags:
    - install
    - dotfiles
    - stow
    - linux-only

- name: Install stow on macOS
  community.general.homebrew:
    name: stow
    state: present
  when: ansible_system == "Darwin"
  tags:
    - install
    - dotfiles
    - stow
    - macos-only

- name: Ensure .dotfiles directory exists
  file:
    path: "{{ lookup('env', 'HOME') }}/.dotfiles"
    state: directory
    mode: '0700'
  tags:
    - install
    - dotfiles
    - stow

- name: Sync dotfiles from repo (idempotent)
  ansible.posix.synchronize:
    src: "./dotfiles/"
    dest: "{{ lookup('env', 'HOME') }}/.dotfiles/"
    delete: yes
    recursive: yes
    checksum: yes
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=.gitignore"
      - "--exclude=*.log"
      - "--delete-excluded"
  delegate_to: localhost
  tags:
    - install
    - dotfiles
    - stow

- name: Make scripts executable
  file:
    path: "{{ lookup('env', 'HOME') }}/.dotfiles/{{ item }}"
    mode: '0755'
  loop:
    - 'install'
    - 'stow'
  tags:
    - install
    - dotfiles
    - stow

- name: Run stow to create symlinks
  command: ./stow
  args:
    chdir: "{{ lookup('env', 'HOME') }}/.dotfiles"
  register: stow_output
  changed_when: false
  tags:
    - install
    - dotfiles
    - stow
